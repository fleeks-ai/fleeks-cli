name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write
  id-token: write  # For Workload Identity Federation with GCP

jobs:
  build:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows builds
          - os: windows-latest
            goos: windows
            goarch: amd64
            binary_name: fleeks.exe
            asset_name: fleeks-windows-amd64.exe
          
          # macOS builds
          - os: macos-latest
            goos: darwin
            goarch: amd64
            binary_name: fleeks
            asset_name: fleeks-darwin-amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            binary_name: fleeks
            asset_name: fleeks-darwin-arm64
          
          # Linux builds
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            binary_name: fleeks
            asset_name: fleeks-linux-amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            binary_name: fleeks
            asset_name: fleeks-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Get dependencies
        run: go mod download

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          go build -v -trimpath -ldflags="-s -w -X 'main.Version=${{ steps.get_version.outputs.VERSION }}' -X 'main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" -o ${{ matrix.binary_name }} .

      - name: Test binary
        if: matrix.goos == runner.os
        run: ./${{ matrix.binary_name }} --version

      - name: Rename binary for upload
        shell: bash
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            mv ${{ matrix.binary_name }} ${{ matrix.asset_name }}
          else
            mv ${{ matrix.binary_name }} ${{ matrix.asset_name }}
            chmod +x ${{ matrix.asset_name }}
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.asset_name }}
          retention-days: 1

  release:
    name: Create Release & Upload to GCS
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure of downloaded files
        run: ls -R ./artifacts

      - name: Move artifacts to release directory
        run: |
          mkdir -p ./release
          find ./artifacts -type f -exec mv {} ./release/ \;
          ls -lh ./release

      - name: Generate checksums
        working-directory: ./release
        run: |
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/740920212667/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'fleeks-cli-uploader@fleeks-ai-production.iam.gserviceaccount.com'

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload binaries to GCS (versioned)
        working-directory: ./release
        run: |
          VERSION=v${{ steps.get_version.outputs.VERSION }}
          gcloud storage cp * gs://fleeks-cli-releases/${VERSION}/ \
            --cache-control="public, max-age=31536000, immutable" \
            --project=fleeks-ai-production
          
          echo "âœ… Uploaded to gs://fleeks-cli-releases/${VERSION}/"
          echo "ðŸŒ Available at: http://downloads.fleeks.ai/${VERSION}/"

      - name: Upload installation scripts to GCS
        run: |
          VERSION=v${{ steps.get_version.outputs.VERSION }}
          
          # Upload to versioned folder
          gcloud storage cp install.sh gs://fleeks-cli-releases/${VERSION}/install.sh \
            --cache-control="public, max-age=31536000, immutable" \
            --project=fleeks-ai-production
          gcloud storage cp install.ps1 gs://fleeks-cli-releases/${VERSION}/install.ps1 \
            --cache-control="public, max-age=31536000, immutable" \
            --project=fleeks-ai-production
          
          echo "âœ… Uploaded installation scripts to versioned folder"

      - name: Update 'latest' folder
        working-directory: ./release
        run: |
          gcloud storage cp * gs://fleeks-cli-releases/latest/ \
            --cache-control="public, max-age=3600" \
            --project=fleeks-ai-production
          
          echo "âœ… Updated latest version"
          echo "ðŸŒ Available at: http://downloads.fleeks.ai/latest/"

      - name: Upload installation scripts to root (for one-liner installs)
        run: |
          # Upload to root level for easy access
          gcloud storage cp install.sh gs://fleeks-cli-releases/install.sh \
            --cache-control="public, max-age=3600" \
            --project=fleeks-ai-production
          gcloud storage cp install.ps1 gs://fleeks-cli-releases/install.ps1 \
            --cache-control="public, max-age=3600" \
            --project=fleeks-ai-production
          
          # Also upload to latest folder
          gcloud storage cp install.sh gs://fleeks-cli-releases/latest/install.sh \
            --cache-control="public, max-age=3600" \
            --project=fleeks-ai-production
          gcloud storage cp install.ps1 gs://fleeks-cli-releases/latest/install.ps1 \
            --cache-control="public, max-age=3600" \
            --project=fleeks-ai-production
          
          echo "âœ… Uploaded installation scripts to root and latest"
          echo "ðŸŒ Quick install: curl -fsSL http://downloads.fleeks.ai/install.sh | bash"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=v${{ steps.get_version.outputs.VERSION }}
          cat > release_notes.md << 'EOF'
          ## Fleeks CLI ${{ steps.get_version.outputs.VERSION }}
          
          ### Installation
          
          #### Quick Install (Recommended)
          
          **macOS / Linux:**
          ```bash
          curl -fsSL http://downloads.fleeks.ai/install.sh | bash
          ```
          
          **Windows (PowerShell):**
          ```powershell
          iwr -useb http://downloads.fleeks.ai/install.ps1 | iex
          ```
          
          #### Manual Installation
          
          **macOS:**
          ```bash
          # Intel Macs
          curl -L http://downloads.fleeks.ai/${VERSION}/fleeks-darwin-amd64 -o fleeks
          chmod +x fleeks
          sudo mv fleeks /usr/local/bin/
          
          # Apple Silicon (M1/M2/M3)
          curl -L http://downloads.fleeks.ai/${VERSION}/fleeks-darwin-arm64 -o fleeks
          chmod +x fleeks
          sudo mv fleeks /usr/local/bin/
          ```
          
          **Linux:**
          ```bash
          # AMD64
          curl -L http://downloads.fleeks.ai/${VERSION}/fleeks-linux-amd64 -o fleeks
          chmod +x fleeks
          sudo mv fleeks /usr/local/bin/
          
          # ARM64
          curl -L http://downloads.fleeks.ai/${VERSION}/fleeks-linux-arm64 -o fleeks
          chmod +x fleeks
          sudo mv fleeks /usr/local/bin/
          ```
          
          **Windows:**
          Download [fleeks-windows-amd64.exe](http://downloads.fleeks.ai/${VERSION}/fleeks-windows-amd64.exe) and add it to your PATH.
          
          ### Direct Downloads
          
          - [Windows (x64)](http://downloads.fleeks.ai/${VERSION}/fleeks-windows-amd64.exe)
          - [macOS (Intel)](http://downloads.fleeks.ai/${VERSION}/fleeks-darwin-amd64)
          - [macOS (Apple Silicon)](http://downloads.fleeks.ai/${VERSION}/fleeks-darwin-arm64)
          - [Linux (x64)](http://downloads.fleeks.ai/${VERSION}/fleeks-linux-amd64)
          - [Linux (ARM64)](http://downloads.fleeks.ai/${VERSION}/fleeks-linux-arm64)
          - [SHA256 Checksums](http://downloads.fleeks.ai/${VERSION}/SHA256SUMS.txt)
          
          ### What's Changed
          
          See the [CHANGELOG](CHANGELOG.md) for full details.
          
          ### Verification
          
          Verify your download with SHA256 checksums:
          ```bash
          # Download checksums
          curl -L http://downloads.fleeks.ai/${VERSION}/SHA256SUMS.txt -o SHA256SUMS.txt
          
          # Verify (Linux/macOS)
          sha256sum -c SHA256SUMS.txt --ignore-missing
          
          # Verify (Windows PowerShell)
          $expected = (Get-Content SHA256SUMS.txt | Select-String "fleeks-windows-amd64.exe").ToString().Split()[0]
          $actual = (Get-FileHash fleeks-windows-amd64.exe).Hash.ToLower()
          if ($expected -eq $actual) { Write-Host "âœ“ Verified!" } else { Write-Host "âœ— Hash mismatch!" }
          ```
          EOF
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: ./release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release
    needs: release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Release v${{ steps.get_version.outputs.VERSION }} published successfully!"
          echo "ðŸ“¦ Binaries available at: http://downloads.fleeks.ai/v${{ steps.get_version.outputs.VERSION }}/"
          echo "ðŸš€ Users can install with: curl -fsSL http://downloads.fleeks.ai/install.sh | bash"
